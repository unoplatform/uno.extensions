using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
//using Chinook.DynamicMvvm;

namespace ApplicationTemplate.Presentation
{
    public class LicensesPageViewModel : ViewModel
    {
        private const string LicensesFileName = "ThirdPartySoftwareLicenses.txt";

        public LicensesPageViewModel()
        {
            LoadLicenses();
        }

        private async void LoadLicenses()
        {
            Licenses = await GetLicenses();
        }

        private string licenses;
        public string Licenses {
            get => licenses;
            set => SetProperty(ref licenses, value);
        }//=> this.GetFromTask(GetLicenses, initialValue: string.Empty);

        private async Task<string> GetLicenses()
        {
            var assembly = GetType().Assembly;

            var actualResourceName = assembly
                .GetManifestResourceNames()?.FirstOrDefault(name => name
                .EndsWith(LicensesFileName, StringComparison.OrdinalIgnoreCase)
            );

            if (actualResourceName == null)
            {
//-:cnd:noEmit
#if __PRODUCTION__
//+:cnd:noEmit
                return string.Empty;
//-:cnd:noEmit
#else
//+:cnd:noEmit
                return $"Couldn't locate '{LicensesFileName}'. Please generate it using the GenerateThirdPartySoftwareLicenses script available in the project.";
//-:cnd:noEmit
#endif
//+:cnd:noEmit
            }

            var resourceStream = assembly.GetManifestResourceStream(actualResourceName);

            using (var streamReader = new StreamReader(resourceStream))
            {
                return await streamReader.ReadToEndAsync();
            }
        }
    }
}
