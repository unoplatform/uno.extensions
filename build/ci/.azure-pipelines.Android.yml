jobs:
- job: Samples_Android
  displayName: 'Samples - Android'

  pool:
    vmImage: macos-latest

  variables:
    NUGET_PACKAGES: $(Agent.WorkFolder)/.nuget
    VS_MSBUILD: '/Applications/Visual Studio.app/Contents/MonoBundle/MSBuild/Current/bin/MSBuild.dll'

  workspace:
    clean: all

  steps:
  - task: UseDotNet@2
    displayName: 'Use .NET 5.0.x'
    inputs:
        packageType: sdk
        version: 5.0.x

  - template: templates/dotnet-install-mac.yml
  - template: templates/canary-updater.yml

  - task: gitversion/setup@0
    retryCountOnTaskFailure: 3
    inputs:
        versionSpec: '5.10.3'

  - task: gitversion/execute@0
    retryCountOnTaskFailure: 3
    inputs:
      useConfigFile: true
      configFilePath: build/ci/gitversion.yml
    displayName: Use GitVersion

  - script: |
      mono '$(VS_MSBUILD)' '$(build.sourcesdirectory)/samples/Playground/Playground.Droid/Playground.Droid.csproj' /r /p:Configuration=Release "/bl:$(build.artifactstagingdirectory)/samples-android-1.binlog" "/p:InformationalVersion=$GITVERSION_INFORMATIONALVERSION" /p:UnoExtensionsDisableNet7=true /p:AotAssemblies=false /p:AndroidBuildApplicationPackage=True

    displayName: Build Android App
    
  - task: CopyFiles@2
    displayName: 'Publish Android Binaries'
    inputs:
      SourceFolder: $(build.sourcesdirectory)/samples/Playground/Playground.Droid/bin/Release
      Contents: |
        **/*.aab
        **/*.apk
      TargetFolder: $(build.artifactstagingdirectory)/Android
      CleanTargetFolder: false
      OverWrite: false
      flattenFolders: false

  - script: |
      mono '$(VS_MSBUILD)' '$(build.sourcesdirectory)/samples/Playground/Playground.Droid/Playground.Droid.csproj' /r /p:Configuration=Release "/bl:$(build.artifactstagingdirectory)/samples-android-2.binlog" "/p:InformationalVersion=$GITVERSION_INFORMATIONALVERSION" /p:UnoExtensionsDisableNet7=true /p:AotAssemblies=false /p:BuildForPlayStore=true /p:AndroidBuildApplicationPackage=True

    displayName: Build Android PlayStore App
    
  - task: CopyFiles@2
    displayName: 'Publish Android Binaries'
    inputs:
      SourceFolder: $(build.sourcesdirectory)/samples/Playground/Playground.Droid/bin/Release
      Contents: |
        **/*-Signed.aab
        **/*-Signed.apk
      TargetFolder: $(build.artifactstagingdirectory)/Android
      CleanTargetFolder: false
      OverWrite: false
      flattenFolders: false

  - task: PublishBuildArtifacts@1
    condition: always()
    inputs:
        ArtifactName: $(Build.DefinitionName)
